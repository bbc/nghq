/*
 * nghq
 *
 * Copyright (c) 2018 British Broadcasting Corporation
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

#include <stdlib.h>
#include <string.h>

#include "multicast.h"
#include "util.h"

static const uint8_t fake_client_initial_packet[] = {
    0xff,     /* Long header | Initial packet */
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, /* connection id = 1 */
    0xff, 0x00, 0x00, 0x09, /* version = 0xff000009 */
    0x00, 0x00, 0x00, 0x00, /* Packet number = 0 */
    0x12,     /* Stream frame with length */
    0x00,       /* Stream ID = 0 */
    0x37,       /* Length = 55 */
    /*** Transport Parameters ***/
    0xff, 0x00, 0x00, 0x09, /* Initial QUIC version: draft-09 */
    0x00, 0x31,   /* Size of optional parameters = 49 */
    0x00, 0x00,   /* initial_max_stream_data */
    0x00, 0x04, 0x00, 0x04, 0x00, 0x00, /* 32 bit, 262144 */
    0x00, 0x01,   /* initial_max_data */
    0x00, 0x04, 0x00, 0x10, 0x00, 0x00, /* 32 bit, 1048576 */
    0x00, 0x02,   /* initial_max_stream_id_bidi (optional) */
    0x00, 0x04, 0x00, 0x00, 0x00, 0x01, /* 32 bit, 1 */
    0x00, 0x03,   /* idle_timeout */
    0x00, 0x02, 0x00, 0x1e, /* 16-bit, 30 */
    0x00, 0x05,   /* max_packet_size */
    0x00, 0x02, 0xff, 0xf7, /* 16-bit, 65527 */
    0x00, 0x07,   /* ack_delay_exponent */
    0x00, 0x01, 0x03, /* 8-bit, 3 */
    0x00, 0x08,   /* initial_max_stream_id_uni */
    0x00, 0x04, 0xff, 0xff, 0xff, 0xff, /* 32-bit, 4294967295 - for push promises! */
    /*** End Transport Parameters ***/
    0x12,     /* Stream frame with length */
    0x02,       /* Stream ID = 2, Client control stream */
    0x00,       /* Length = 0 */ /* TODO: Add a SETTINGS frame */
    0x00,     /* Padding frame */
                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 79 - 84 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 85 - 92 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 93 - 100 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 101 - 108 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 109 - 116 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 117 - 124 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 125 - 132 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 133 - 140 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 141 - 148 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 149 - 156 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 157 - 164 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 165 - 172 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 173 - 180 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 181 - 188 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 189 - 196 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 197 - 204 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 205 - 212 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 213 - 220 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 221 - 228 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 229 - 236 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 237 - 244 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 245 - 252 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 253 - 260 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 261 - 268 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 269 - 276 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 277 - 284 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 285 - 292 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 293 - 300 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 301 - 308 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 309 - 316 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 317 - 324 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 325 - 332 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 333 - 340 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 341 - 348 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 349 - 356 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 357 - 364 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 365 - 372 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 373 - 380 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 381 - 388 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 389 - 396 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 397 - 404 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 405 - 412 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 413 - 420 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 421 - 428 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 429 - 436 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 437 - 444 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 445 - 452 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 453 - 460 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 461 - 468 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 469 - 476 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 477 - 484 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 485 - 492 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 493 - 500 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 501 - 508 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 509 - 516 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 517 - 524 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 525 - 532 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 533 - 540 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 541 - 548 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 549 - 556 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 557 - 564 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 565 - 572 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 573 - 580 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 581 - 588 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 589 - 596 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 597 - 604 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 605 - 612 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 613 - 620 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 621 - 628 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 629 - 636 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 637 - 644 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 645 - 652 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 653 - 660 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 661 - 668 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 669 - 676 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 677 - 684 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 685 - 692 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 693 - 700 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 701 - 708 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 709 - 716 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 717 - 724 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 725 - 732 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 733 - 740 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 741 - 748 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 749 - 756 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 757 - 764 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 765 - 772 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 773 - 780 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 781 - 788 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 789 - 796 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 797 - 804 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 805 - 812 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 813 - 820 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 821 - 828 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 829 - 836 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 837 - 844 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 845 - 852 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 853 - 860 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 861 - 868 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 869 - 876 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 877 - 884 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 885 - 892 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 893 - 900 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 901 - 908 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 909 - 916 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 917 - 924 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 925 - 932 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 933 - 940 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 941 - 948 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 949 - 956 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 957 - 964 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 965 - 972 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 973 - 980 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 981 - 988 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 989 - 996 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 997 - 1004 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1005 - 1012 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1013 - 1020 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1021 - 1028 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1029 - 1036 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1037 - 1044 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1045 - 1052 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1053 - 1060 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1061 - 1068 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1069 - 1076 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1077 - 1084 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1085 - 1092 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1093 - 1100 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1101 - 1108 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1109 - 1116 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1117 - 1124 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1125 - 1132 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1133 - 1140 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1141 - 1148 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1149 - 1156 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1157 - 1164 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1165 - 1172 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1173 - 1180 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1181 - 1188 */
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* padding 1189 - 1196 */
    0x00, 0x00, 0x00                                /* padding 1197 - 1199 */
};
#define LENGTH_INITIAL_PACKET sizeof(fake_client_initial_packet)

static const uint8_t fake_server_handshake_packet[] = {
    0xfd,     /* Long header | Handshake packet */
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, /* connection id = 1 */
    0xff, 0x00, 0x00, 0x09, /* version = 0xff000009 */
    0x67, 0x45, 0x23, 0x01, /* Packet number = 0x01234567 */
    0x12,     /* Stream frame with length */
    0x00,       /* Stream ID = 0 */
    0x40, 0x45,       /* Length = 69 */
    /*** Transport Parameters ***/
    0xff, 0x00, 0x00, 0x09, /* "Negotiated" version: draft-09 */
    0x04,                     /* Length of Supported versions: 4 bytes/1 ver */
    0xff, 0x00, 0x00, 0x09,   /* Supported version 1: draft-09 */
    0x00, 0x3a,   /* Length of Parameters: 58 */
    0x00, 0x00,     /* initial_max_stream_data */
    0x00, 0x04, 0x00, 0x04, 0x00, 0x00, /* 32-bit, 262144 */
    0x00, 0x01,     /* initial_max_data */
    0x00, 0x04, 0x00, 0x10, 0x00, 0x00, /* 32-bit, 1048576 */
    0x00, 0x03,     /* idle_timeout */
    0x00, 0x02, 0x00, 0x3c,             /* 16-bit, 30 */
    0x00, 0x06,     /* Stateless reset token */
    0x00, 0x10,       /* 16 bytes */
    0x71, 0x75, 0x69, 0x63, 0x2d, 0x6d, 0x63, 0x61, /* quic-mcast magic */
    0x73, 0x74, 0x20, 0x6d, 0x61, 0x67, 0x69, 0x63,
    0x00, 0x02,     /* initial_max_stream_id_bidi */
    0x00, 0x04, 0x00, 0x00, 0x00, 0x04, /* 32-bit, 4 */
    0x00, 0x08,     /* initial_max_stream_id_uni */
    0x00, 0x04, 0x00, 0x00, 0x00, 0x02, /* 32-bit, 2 */
    /*** End Transport Parameters ***/
    0x12,     /* Stream frame with length */
    0x03,       /* Stream ID = 3, Server-initiated HTTP control stream */
    0x00,       /* Length = 0 */ /* TODO: Add SETTINGS frame */
};

#define LENGTH_SERVER_HANDSHAKE_PACKET sizeof(fake_server_handshake_packet)

static const uint8_t fake_client_stream_4_packet[] = {
    0x1f, /* Short header | ConnID present | Key Phase 0 | PktNum 4 octets*/
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x01, /* connection id = 1 */
    0x02, /* Packet number = 2 */
    0x12, /* Stream frame with length */
    0x04,   /* Stream ID = 4 */
    0x13,   /* Length = 19 */
    0x10, 0x00, 0x00, /* Length 16, data, no flags */
    0x71, 0x75, 0x69, 0x63, 0x2d, 0x6d, 0x63, 0x61, /* quic-mcast magic */
    0x73, 0x74, 0x20, 0x6d, 0x61, 0x67, 0x69, 0x63
};

#define LENGTH_CLIENT_STREAM_4_PACKET sizeof(fake_client_stream_4_packet)

size_t get_fake_client_initial_packet (uint64_t conn_id, uint32_t init_pkt_num,
                                       uint32_t init_max_stream_data,
                                       uint32_t init_max_data, uint8_t **pkt) {
  uint8_t *buf = (uint8_t *) malloc (LENGTH_INITIAL_PACKET);
  if (buf == NULL) {
    return 0;
  }

  memcpy (buf, fake_client_initial_packet, LENGTH_INITIAL_PACKET);

  put_uint64_in_buf (buf + 1, conn_id);
  put_uint32_in_buf (buf + 13, init_pkt_num);
  put_uint32_in_buf (buf + 30, init_max_stream_data);
  put_uint32_in_buf (buf + 38, init_max_data);

  *pkt = buf;
  return LENGTH_INITIAL_PACKET;
}

size_t get_fake_server_handshake_packet (uint64_t conn_id, uint32_t pkt_num,
                                         uint32_t init_max_stream_data,
                                         uint32_t init_max_data, uint8_t **pkt) {
  uint8_t *buf = (uint8_t *) malloc (LENGTH_SERVER_HANDSHAKE_PACKET);
  if (buf == NULL) {
    return 0;
  }

  memcpy (buf, fake_server_handshake_packet, LENGTH_SERVER_HANDSHAKE_PACKET);

  put_uint64_in_buf (buf + 1, conn_id);
  put_uint32_in_buf (buf + 13, pkt_num);
  put_uint32_in_buf (buf + 36, init_max_stream_data);
  put_uint32_in_buf (buf + 44, init_max_data);

  *pkt = buf;
  return LENGTH_SERVER_HANDSHAKE_PACKET;
}

size_t get_fake_client_stream_4_packet (uint64_t conn_id, uint32_t pkt_num,
                                        uint64_t max_data, uint8_t **pkt) {
  size_t len = LENGTH_CLIENT_STREAM_4_PACKET + 1 +
        _make_varlen_int(NULL, max_data);
  uint8_t *buf = (uint8_t *) malloc (len);
  if (buf == NULL) {
    return 0;
  }

  memcpy (buf, fake_client_stream_4_packet, LENGTH_CLIENT_STREAM_4_PACKET);

  put_uint64_in_buf (buf + 1, conn_id);
  buf[9] = pkt_num & 0xff;

  buf[LENGTH_CLIENT_STREAM_4_PACKET] = 0x04; /* MAX_DATA frame */
  _make_varlen_int(buf + LENGTH_CLIENT_STREAM_4_PACKET + 1, max_data);

  *pkt = buf;
  return len;
}
